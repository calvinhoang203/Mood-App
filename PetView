import SwiftUI

struct PetView: View {
    @EnvironmentObject var petCustomization: PetCustomization
    @EnvironmentObject var sharedData: SharedData
    @State private var selectedTab: String = "Colors"
    @State private var unlockedItems: Set<String> = Set(UserDefaults.standard.stringArray(forKey: "unlockedItems") ?? ["defaultcow"])
    @State private var showAlert: Bool = false
    
    let tabs = ["Colors", "Tops", "Extras"]
    
    let colorOptions: [String] = ["displayblue", "displaydarkpurple", "displaygreen", "displaylightgreen", "displaypeach", "displaypink", "displaypurple", "displayred", "displayyellow"]
    let colorImages: [String] = ["bluecow", "darkpurplecow", "darkgreencow", "lightgreencow", "peachcow", "pinkcow", "purplecow", "redcow", "yellowcow"]
    let colorNames: [String] = ["Red", "Blue", "Dark Green", "Green", "Peach", "Purple", "Pink", "Dark Peach", "Default"]
    
    let topImages: [String] = ["tophat", "hoodie", "bowtie"]
    let topNames: [String] = ["Top Hat", "Hoodie", "Bow Tie"]
    
    let extraImages: [String] = ["earing", "glasses", "hat", "necklace", "videogame", "basketball", "bow", "boba", "pants", "mask", "airpods"]
    let extraNames: [String] = ["Earing", "Glasses", "Hat", "Necklace", "Video Game", "Basketball", "Bow", "Boba", "Pants", "Mask", "AirPods"]
    let extraDisplayImages = ["earingview", "glassesview", "hatview", "necklaceview", "videogameview", "basketballview", "bowview", "bobaview", "pantsview", "maskview", "airpodsview"]
    
    var body: some View {
        ZStack {
            Color.white.ignoresSafeArea()
            GeometryReader { geometry in
                VStack {
                    Spacer()
                    
                  
                    ZStack {
                        let imageWidth = geometry.size.width * 1.0
                        let imageHeight = geometry.size.height * 1.0
                        let position_x = geometry.size.width / 1.57
                        let position_y = geometry.size.height * 0.125
                        
                        Ellipse()
                                .fill(Color("lightd3cpurple"))
                                .frame(width: 175, height: 75)
                                .cornerRadius(10)
                                .shadow(color: .gray, radius: 10, x: 5, y: 5)
                                .position(x:position_x * 0.8, y: position_y * 2)

                        petCustomization.defaultcow
                            .resizable()
                            .scaledToFit()
                            .frame(width: imageWidth, height: imageHeight)
                            .position(x: position_x, y: position_y)

                        petCustomization.colorcow
                            .resizable()
                            .scaledToFit()
                            .frame(width: imageWidth, height: imageHeight)
                            .position(x: position_x, y: position_y)

                        petCustomization.topImage
                            .resizable()
                            .scaledToFit()
                            .frame(width: imageWidth, height: imageHeight)
                            .position(x: position_x, y: position_y)

                        petCustomization.extraImage
                            .resizable()
                            .scaledToFit()
                            .frame(width: imageWidth, height: imageHeight)
                            .position(x: position_x, y: position_y)
                    }

                    
                    // Tab Selection
                    HStack {
                        ForEach(tabs, id: \ .self) { tab in
                            Button(action: { selectedTab = tab }) {
                                Text(tab)
                                    .fontWeight(selectedTab == tab ? .bold : .regular)
                                    .foregroundColor(selectedTab == tab ? .white : .gray)
                                    .padding()
                                    .background(selectedTab == tab ? Color.purple : Color.gray.opacity(0.2))
                                    .cornerRadius(10)
                                    .font(.custom("Jua", size: 15))
                            }
                        }
                    }
                    .padding(.vertical)
                    
                    // Display Customization Options
                    ScrollView {
                        if selectedTab == "Colors" {
                            itemGrid(display: colorOptions, items: colorImages, names: colorNames, geometry: geometry) { index in
                                petCustomization.defaultcow = Image(colorImages[index])
                            }
                        } else if selectedTab == "Tops" {
                            itemGrid(display: topImages, items: topImages, names: topNames, geometry: geometry) { index in
                                petCustomization.topImage = Image(topImages[index])
                            }
                        } else if selectedTab == "Extras" {
                            itemGrid(display: extraDisplayImages, items: extraImages, names: extraNames, geometry: geometry) { index in
                                petCustomization.extraImage = Image(extraImages[index])
                            }
                        }
                    }
                    .padding()
                }
            }
            VStack{
                homebar()
                    .frame(maxWidth: .infinity)
                    .background(Color("lightd3cpurple"))
            }
            .frame(maxHeight: .infinity, alignment: .bottom)
        }
        .alert(isPresented: $showAlert) {
            Alert(title: Text("Not Enough Points"), message: Text("You need more points to unlock this item."), dismissButton: .default(Text("OK")))
        }
    }
    
    private func itemGrid(display: [String], items: [String], names: [String], geometry: GeometryProxy, action: @escaping (Int) -> Void) -> some View {
        LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 10), count: 3), spacing: 15) {
            ForEach(items.indices, id: \.self) { index in
                VStack {
                    Image(display[index])
                        .resizable()
                        .scaledToFit()
                        .frame(width: geometry.size.width * 0.1, height: geometry.size.width * 0.1)
                        .clipShape(RoundedRectangle(cornerRadius: 10))
                        .onTapGesture {
                            if unlockedItems.contains(items[index]) {
                                action(index)
                            }
                        }
                    
                    Button(unlockedItems.contains(items[index]) ? "UNLOCKED" : "LOCKED") {
                        unlockItem(items[index])
                    }
                    .font(.custom("Jua", size: 14))
                    .padding(5)
                    .background(unlockedItems.contains(items[index]) ? Color.green : Color.red)
                    .foregroundColor(.white)
                    .cornerRadius(5)
                }
            }
        }
    }

    
    private func unlockItem(_ item: String) {
        if !unlockedItems.contains(item) {
            if sharedData.points >= 50 {
                sharedData.points -= 50
                unlockedItems.insert(item)
                saveUnlockedItems()
            } else {
                showAlert = true
            }
        }
    }
    
    private func saveUnlockedItems() {
        UserDefaults.standard.set(Array(unlockedItems), forKey: "unlockedItems")
    }
}

struct PetView_Previews: PreviewProvider {
    static var previews: some View {
        PetView()
            .environmentObject(PetCustomization())
            .environmentObject(SharedData())
    }
}
